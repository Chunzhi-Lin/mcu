=========
功能列表
=========

UART轮询控制台交互功能
----------------------

在BM1684xEVB中使用USART2作为MCU与用户交互以及调试的串口,波特率为115200。
MCU上电之后会向串口发送最初始的问候语,并阐释固件所适用的板卡类型以及该固件生成的出厂时间。
当MCU每进行一次所负责板卡的某部分上电任务后,会将该部分上电任务完成结果通过串口打印出来。

    用户可通过以下指令与MCU进行交互(指令之外的任何输入会被作为错误输入)

.. code-block:: shell

    #获取所有指令功能
     help
    #问候语得到厂商名称
     hello
    #手动顺序上电
     poweron
    #手动顺序下电
     poweroff
    #获取该MCU固件支持板卡类型
     getmcutype
    #获取SLT寄存器0和1值
     query
    #获取上电状态或为某部分上电
     power //获取上电情况
     power on (上电节点)
    #循环打印输出电流电压功耗以及温度值
     enprint

LED呼吸灯
-----------

当MCU顺利完成所有的上电时序后,MCU所控有且仅有一个的LED以1KHz频率进行闪烁。
当LED不亮,说明MCU断电或者挂死,亦或一开始的上单时序出现问题。

ADC采样
-----------

目前BM1684xEVB使用了四条通道的ADC采样,采样精度为12bit。
四条ad通道采样值分别有以下功能:

- 整版12V电压通道的电流值采集
- 获取硬件版本号
- 获取产品版本号
- 检测ntc板温

SW调试器
----------

引出SWDIO以及SWCLK管脚,可供MCU进行固件升级以及调试,其中常用指令：

.. code-block:: shell

    #使用文件夹中刚生成的固件进行升级，直接在文件夹路径下
    make burn
    #使用其他位置固件升级
    st-flash write 'path'/filename 0x8000000
    #使用GDB调试
    st-util -n
    arm-none-eabi-gdb
    target remote :4242
    ...

I2C_SLAVE
--------------
I2C 从模式模块负责操作 STM32 的 I2C 控制器，接收来自总线上主控制器发送的数据。

I2C 从模式模块是采用了中断响应，异步工作的模式。所有需要使用这个模块的用户都
需要向这个模块注册其回调函数，当 I2C 控制器接收到来自主控制器的数据后，会根据主控
制器发送的从地址，调用注册在这个框架下的模块的回调函数，完成 I2C 响应。

其支持的 I2C事件如表1所示:

~~~~~~~~~~~~~~~~~~~~~~~~~ 表1 ~~~~~~~~~~~~~~~~~~~~~~~

===========  ==================================
    事件       说明
===========  ==================================
    match      从设备接收到了注册设备声明的地址
-----------  ----------------------------------
    read       主设备发送了一个读请求，注册的设备需要回填返回给主设备的数据
-----------  ----------------------------------
    write      主设备发送了一个写请求，注册设备需要处理主设备写入的数据
-----------  ----------------------------------
    stop       主设备发送了停止信号
===========  ==================================

目前BM1684xEVB使用I2C1作为slave,另一端连接1684芯片的i2c1。MCU寄存器的地址为0x17,并且开启掩码多地址功能, 0x68~0x6f
都能做为MCU的地址,只不过MCU将不同的地址对应到自己模拟出来的不同功能模块中,部分是MCU内部功能,
部分为实现PC到挂载在MCU上的设备之间的透传。以下详细介绍:

MCU寄存器 (0x17)
~~~~~~~~~~~~~~~~~

pc端通过访问0x17地址,能够对MCU寄存器进行读写,其中MCU寄存器功能将在后续列表中展现。

WDT看门狗 (0x69)
~~~~~~~~~~~~~~~~~

看门狗模块负责在系统发生异常，无法再继续执行后重启系统。看门狗内部包括一个计
时器，当看门狗使能后,计时器开始工作,当计时器超时后,MCU 将复位 BM1684,使系
统重新启动。运行于 BM1684xEVB上的软件需要设置这个超时时间,并在这个事件之内重置看门
狗的计数器。

EEPROM   (0x6a)
~~~~~~~~~~~~~~~~~

用于存储核心板1684x相关信息,定义为每32个字节作为一个存储单元,每个单元可用于单一功能或者复合功能。
作为BSP基础信息区域。

tmp451   (0x6b)
~~~~~~~~~~~~~~~~~
温度传感器,挂载在MCU上,MCU通过I2C2作为master对其地址0x4c进行访问。

tca6416  (0x6c)
~~~~~~~~~~~~~~~~~

I2C 接口的 GPIO 扩展芯片,MCU主要负责信号透传的工作。

Keyboard (0x6d)
~~~~~~~~~~~~~~~~~
虚拟按键模块收集外部按键事件并通过 I2C 接口反馈给 BM1684xEVB。虚拟按键事件实现了
地址设置,随机读取和随机写入等协议,实现了一个 256 个端口,每个端口 8 个虚拟按键事件的模型.

SLT      (0x6f)
~~~~~~~~~~~~~~~~~
MCU为芯片系统自动化提供64byte寄存器空间,供slt工作时状态、数据存取。

I2C_MASTER
--------------

目前BM1684xEVB仅使用了I2C2作为I2C_MASTER, I2C 主模式模块负责操作 STM32 的 I2C 控制器发出满足 I2C 协议的传输。
I2C 控制器主模式工作频率 100KHz,地址模式为 7 比特模式，支持 clock stretching,
支持超时重传机制。

用途：

- 最主要是与PMIC电源管理芯片MP5475通信,配置输出电压
- 温度传感器tmp451温度信息获取以及配置设备
- gpio拓展版tca6416透传
- ...


GPIO 引脚
-------------

上面叙述的LED也是属于普通GPIO引脚操作,还包括控制poweron sequence拉高拉低引脚。
BM1684xEVB同时还包含着十余个其他用途GPIO引脚,例如用于检测soc/PCIe/mix mode的引脚,
校验各部分上电完成状态的引脚,PMIC异常检测的引脚,Key 按键MCU复位引脚...

















